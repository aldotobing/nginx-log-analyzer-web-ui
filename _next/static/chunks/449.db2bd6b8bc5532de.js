self.onmessage=t=>{let e=t.data,s=e.logContent||e,a=e.format||"nginx",r={requestStats:{totalRequests:0,uniqueIPs:new Set,totalAttackAttempts:0,parseErrors:0},httpMethods:{},statusCodes:{"2xx":0,"3xx":0,"4xx":0,"5xx":0},attackDistribution:{"SQL Injection":0,XSS:0,"Command Injection":0,"Directory Traversal":0,"Brute Force":0},trafficOverTime:Array(24).fill(0).map((t,e)=>({hour:e,count:0})),recentAttacks:[],ipStats:{requestCounts:{},attackCounts:{},statusCodes:{},methods:{},bandwidthUsage:{},lastSeen:{},userAgents:{},paths:{}},referrerCounts:{},requestedUrlCounts:{}},n=["GET","POST","PUT","DELETE","HEAD","OPTIONS","PATCH","CONNECT","TRACE"],o={"SQL Injection":RegExp("(?:%27|'|--|;|--\\s|/\\*.*?\\*/|#|%23|%2527)|\\b(?:UNION\\s+(?:ALL\\s+)?SELECT|SELECT\\s+.*?\\bFROM|INSERT\\s+INTO|DELETE\\s+FROM|UPDATE\\s+\\w+\\s+SET|DROP\\s+(?:TABLE|DATABASE)|CREATE\\s+(?:TABLE|DATABASE)|ALTER\\s+TABLE)\\b|(?:[?&][^=]*=(?:%27|'|%2527).*?(?:OR|AND|X?OR|NOT).*?=|\\b(?:OR|AND|X?OR|NOT)\\s+['\\d]\\s*[=<>~!]?=)|\\b(?:EXEC(?:UTE)?(?:\\(|\\s)|EXEC\\s+SP_|XP_|sp_|xp_|WAITFOR\\s+DELAY|SLEEP\\s*\\(|BENCHMARK\\s*\\(|PG_SLEEP\\s*\\(|UPDATEXML\\s*\\(|EXTRACTVALUE\\s*\\()|\\b(?:CHAR\\(|CONCAT\\(|GROUP_CONCAT\\()|[?&][^=]+=(?:%27|'|%2527).*?(?:OR|AND|X?OR|NOT).*?=|[?&][^=]+=.*?(?:--|#|%23|;)","i"),XSS:RegExp("<script[^>]*>|javascript:|(?:on(?:load|error|click|mouse(?:over|out|move)|key(?:down|up|press)|submit|focus|blur|change))\\s*=|eval\\s*\\(|document\\.(?:cookie|location|write|URL|referrer)|<(?:iframe|img|svg|object|embed|frame|frameset|meta|link|form|input|button|textarea|select|option|style|base|body|html)|expression\\s*\\(|data:text(?:html|javascript)|vbscript:","i"),"Command Injection":RegExp("\\b(?:cat|ls|uname|whoami|pwd|rm|touch|wget|curl|scp|rsync|ftp|nc|ncat|nmap|ping|traceroute|telnet|ssh|bash|sh|zsh|dash|powershell|cmd\\.exe|cmd\\/c|\\|\\||&&|;)\\b|\\$\\s*\\(.*\\)|`.*`|\\|\\|\\s*\\w+|&&\\s*\\w+|\\|\\s*\\w+|>\\s*\\w+|<\\s*\\w+|\\b(?:exec|system|passthru|shell_exec|popen|proc_open|pcntl_exec)\\s*\\(","i"),"Directory Traversal":RegExp("(?:^|/|\\\\)(?:\\.{1,2}[\\./\\\\]){2,}|(?:^|/|\\\\)(?:%2e%2e|%252e%252e|%c0%ae%c0%ae|%u002e%u002e)[/\\\\]|/(?:etc/(?:passwd|shadow|group|hosts)|proc/self/environ|windows/win\\.ini|boot\\.ini|php\\.ini|my\\.cnf)(?:/|$|\\x00)|^[a-zA-Z]:\\\\[^/]+|\\.\\.\\.(?:%2f|%252f|%5c|%255c)|\\\\x00|%00|\\\\0|%25(?:2e|25|5c|2f|5f|3d|3f|26|3a|3b)","i"),"Brute Force":RegExp("\\b(?:wp-|wp_|xmlrpc\\.php|admin-ajax\\.php|wp-login\\.php|wp-admin/)\\b|\\b(?:/admin/|/wp-admin/|/administrator/|/backend/|/control/|/cp/|/cpanel/|/manager/|/admincp/|/admin[1-9]|/admin10/)\\b|\\b(?:/login\\.(?:php|asp|aspx|jsp|do|pl|cgi|cfm|phtml|shtml|rb|py))\\b|(?:/wp-login\\.php|/administrator/login|/admin/login|/user/login|/auth/login|/api/login|/v\\d+/login)","i")},i=s.split("\n"),c=i.length,u=0,p=[];i.forEach((t,e)=>{e%1e3==0&&self.postMessage({progress:Math.round(e/c*100)});let s=t.trim();if(!s)return;let i=((t,e)=>{try{let s;if("nginx"===e){if(!(s=t.match(/^(\S+) - (\S+) \[(.*?)\] "(\S+) ([^"]*) HTTP\/\d+\.\d+" (\d+) (\d+) "([^"]*)" "([^"]*)" "([^"]*)"$/)))return null;let e=s[5],[a,r]=e.split("?");return{ipAddress:s[1],remoteUser:s[2],timestamp:s[3],method:s[4],path:a,query:r||"",fullPath:e,status:s[6],bodyBytesSent:s[7],referer:s[8],userAgent:s[9],xForwardedFor:s[10]}}if("apache"===e){if(!(s=t.match(/^(\S+)\s+\S+\s+(\S+)\s+\[([^\]]+)\]\s+"(\S+)\s+([^\s"]+)(?:\s+HTTP\/[\d.]+)?"\s+(\d{3})\s+(\d+|-)/)))return null;let e=s[5],[a,r]=e.split("?");return{ipAddress:s[1],remoteUser:s[2],timestamp:s[3],method:s[4],path:a,query:r||"",fullPath:e,status:s[6],bodyBytesSent:"-"===s[7]?"0":s[7],referer:"-",userAgent:"-",xForwardedFor:"-"}}return null}catch(t){return null}})(s,a);if(!i)return void r.requestStats.parseErrors++;u++;let{ipAddress:l,remoteUser:d,timestamp:h,method:m,path:S,status:f,bodyBytesSent:g,referer:A,userAgent:E,xForwardedFor:T}=i;if(!n.includes(m))return;(t=>{r.ipStats.requestCounts[t]||(r.ipStats.requestCounts[t]=0,r.ipStats.attackCounts[t]=0,r.ipStats.statusCodes[t]={"2xx":0,"3xx":0,"4xx":0,"5xx":0},r.ipStats.methods[t]={},r.ipStats.bandwidthUsage[t]=0,r.ipStats.userAgents[t]=new Set,r.ipStats.paths[t]=new Set)})(l);let C=parseInt(g,10)||0;r.ipStats.requestCounts[l]++,r.ipStats.bandwidthUsage[l]+=C,r.ipStats.lastSeen[l]=h,r.ipStats.paths[l].add(S),r.ipStats.methods[l][m]=(r.ipStats.methods[l][m]||0)+1,r.ipStats.statusCodes[l]["".concat(f[0],"xx")]++,"nginx"===a&&(r.ipStats.userAgents[l].add(E),A&&"-"!==A&&(r.referrerCounts[A]=(r.referrerCounts[A]||0)+1)),r.requestStats.totalRequests++,r.requestStats.uniqueIPs.add(l),r.httpMethods[m]=(r.httpMethods[m]||0)+1,r.statusCodes["".concat(f[0],"xx")]++,r.requestedUrlCounts[S]=(r.requestedUrlCounts[S]||0)+1;try{let t=new Date(h.replace(/\[|\]/g,"")).getHours();!isNaN(t)&&t>=0&&t<24&&r.trafficOverTime[t].count++}catch(t){}let b=null,x=i.fullPath||S;for(let[t,e]of Object.entries(o))if(e.test(x)){console.log("[ATTACK DETECTED] Type: ".concat(t,", Path: ").concat(x)),r.attackDistribution[t]||(r.attackDistribution[t]=0),r.attackDistribution[t]++,r.requestStats.totalAttackAttempts++,r.ipStats.attackCounts[l]=(r.ipStats.attackCounts[l]||0)+1,b=t;let e="".concat(l,":").concat(t,":").concat(S);r.recentAttacks.some(t=>"".concat(t.ipAddress,":").concat(t.attackType,":").concat(t.requestPath)===e)||(r.recentAttacks.push({timestamp:h,ipAddress:l,remoteUser:d,attackType:t,requestPath:S,fullPath:x,method:m}),r.recentAttacks.length>100&&r.recentAttacks.shift(),console.log("[NEW ATTACK] ".concat(t," from ").concat(l," at ").concat(h,": ").concat(m," ").concat(x)))}p.push({...i,attackType:b});try{let t=h.replace(/\[|\]/g,""),e=new Date(t.replace(/(\d{2})\/(\w{3})\/(\d{4}):(\d{2}:\d{2}:\d{2})/,"$2 $1 $3 $4"));if(e instanceof Date&&!isNaN(e)){let t=e.getHours();t>=0&&t<24&&r.trafficOverTime[t].count++}else console.warn("Invalid timestamp format:",t)}catch(t){console.warn("Error processing timestamp:",t)}});let l=r.trafficOverTime.map(t=>({hour:t.hour,count:t.count}));if(0===u)return void self.postMessage({error:"This file doesn't appear to be a valid Nginx or Apache Http log. Please check the format and try again."});let d={requestStats:{...r.requestStats,uniqueIPs:r.requestStats.uniqueIPs.size},httpMethods:r.httpMethods,statusCodes:r.statusCodes,attackDistribution:r.attackDistribution,trafficOverTime:l,topIp:Object.fromEntries(Object.entries(r.ipStats.requestCounts).sort((t,e)=>{let[,s]=t,[,a]=e;return a-s}).slice(0,10)),topReferrers:"nginx"===a?Object.fromEntries(Object.entries(r.referrerCounts).sort((t,e)=>{let[,s]=t,[,a]=e;return a-s}).slice(0,10)):{},topRequestedUrls:Object.fromEntries(Object.entries(r.requestedUrlCounts).sort((t,e)=>{let[,s]=t,[,a]=e;return a-s}).slice(0,10)),suspiciousIps:Object.entries(r.ipStats.attackCounts).filter(t=>{let[,e]=t;return e>0}).sort((t,e)=>{let[,s]=t,[,a]=e;return a-s}).reduce((t,e)=>{let[s,a]=e;return t[s]={attackCount:a,requestCount:r.ipStats.requestCounts[s],lastSeen:r.ipStats.lastSeen[s],uniquePaths:r.ipStats.paths[s].size,uniqueUserAgents:r.ipStats.userAgents[s].size,bandwidthUsage:r.ipStats.bandwidthUsage[s],methods:r.ipStats.methods[s],statusCodes:r.ipStats.statusCodes[s]},t},{}),recentAttacks:r.recentAttacks.slice(-100).reverse()};self.postMessage({stats:d,parsedLines:p})},_N_E={};